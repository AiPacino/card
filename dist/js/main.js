"use strict";var selectedElem,editSide,svg,editCanvas=document.querySelector(".edit-canvas"),editToolbar=document.querySelectorAll(".edit-toolbar"),imageToolbar=document.querySelector(".edit-toolbar-image"),textToolbar=document.querySelector(".edit-toolbar-text"),svgToolbar=document.querySelector(".edit-toolbar-svg"),editTransformer=document.querySelector(".edit-transformer"),sizeSelect=document.querySelector(".size-select"),familySelect=document.querySelector(".family-select"),transparentRange=document.querySelector(".transparent-range"),selectedElemRect,editCanvasRect=editCanvas.getBoundingClientRect(),clipboard,canvasEditor=new CanvasEditor;editSide=document.querySelector(".side-front"),svg=editSide.querySelector("svg"),document.addEventListener("selectstart",function(e){e.returnValue=!1}),editCanvas.addEventListener("click",function(e){canvasEditor.clearStyle(editTransformer,textToolbar,imageToolbar,svgToolbar,sizeSelect,familySelect,transparentRange),e.target.classList.contains("edit-elem")&&(selectedElem=e.target,selectedElemRect=selectedElem.getBoundingClientRect(),editTransformer="path"==selectedElem.tagName?document.querySelector(".svg-transformer"):document.querySelector(".edit-transformer"),canvasEditor.showEditTransformer(),canvasEditor.showEditPanel())});var dragging,tLeft,tTop,moveElem=document.querySelector(".move");document.addEventListener("mousedown",function(e){selectedElem&&(selectedElemRect=selectedElem.getBoundingClientRect()),e.target!=editTransformer&&e.target.parentNode!=moveElem||(canvasEditor.clearStyle(textToolbar,imageToolbar,svgToolbar),dragging=!0,tLeft=e.clientX-selectedElemRect.left,tTop=e.clientY-selectedElemRect.top)}),document.addEventListener("mouseup",function(e){dragging=!1}),document.addEventListener("mousemove",function(e){if(dragging){var t=e.clientX-tLeft-editCanvasRect.left,l=e.clientY-tTop-editCanvasRect.top;if(editTransformer.style.left=selectedElem.style.left=t+"px",editTransformer.style.top=selectedElem.style.top=l+"px","path"==selectedElem.tagName){var a=canvasEditor.getSvgTransform(selectedElem,"scale");console.log(a),selectedElem.setAttribute("transform","translate("+t+","+l+") "+a),editTransformer.style.left=t+"px",editTransformer.style.top=l+"px"}}});var tMouseX,tMouseY,angle,rotating,rotateElemRect,centerX,centerY,rotateControl=document.querySelector(".rotate"),angleRotateControl;document.addEventListener("mousedown",function(e){selectedElem&&(selectedElemRect=selectedElem.getBoundingClientRect(),centerX=selectedElemRect.left+selectedElemRect.width/2,centerY=selectedElemRect.top+selectedElemRect.height/2,angleRotateControl=180*Math.atan(selectedElemRect.height/2/(selectedElemRect.width/2))/Math.PI),e.target.parentNode==rotateControl&&(canvasEditor.clearStyle(textToolbar,imageToolbar),rotating=!0)}),document.addEventListener("mouseup",function(e){rotating=!1,"block"==editTransformer.style.display&&canvasEditor.showEditPanel()}),document.addEventListener("mousemove",function(e){rotating&&(tMouseX=e.clientX-centerX,tMouseY=e.clientY-centerY,angle=Math.abs(180*Math.atan(tMouseY/tMouseX)/Math.PI),tMouseX>=0&&tMouseY<=0&&(angle>angleRotateControl?angle=360-(angle-angleRotateControl):angle<=angleRotateControl&&(angle=angleRotateControl-angle)),tMouseX>=0&&tMouseY>0&&(angle+=angleRotateControl),tMouseX<=0&&tMouseY>=0&&(angle=180+angleRotateControl-angle),tMouseX<=0&&tMouseY<0&&(angle=180+angleRotateControl+angle),selectedElem.style.transform=editTransformer.style.transform="rotate("+angle+"deg)")});var scaling,selectedElemProp,selectedElemOffsetWidth,selectedElemOffsetHeight,scaleOrigin,scaleOriginRect,scaleOriginX,scaleOriginY,oppsiteCorner,oppsiteCornerRect,oppsiteCornerX,oppsiteCornerY,ANGLE,preX,preY;editTransformer.addEventListener("mousedown",function(e){selectedElem&&(selectedElemRect=selectedElem.getBoundingClientRect()),"scale"==e.target.parentNode.className&&selectedElem.classList.contains("edit-image")&&(scaling=!0,selectedElemOffsetWidth=selectedElem.offsetWidth,selectedElemOffsetHeight=selectedElem.offsetHeight,selectedElemProp=selectedElemRect.width/selectedElemRect.height,preX=e.clientX,preY=e.clientY),ANGLE=angle?angle*Math.PI/180:0,scaleOrigin=document.querySelector(".scale"),scaleOriginRect=scaleOrigin.getBoundingClientRect(),scaleOriginX=scaleOriginRect.left+scaleOriginRect.width/2,scaleOriginY=scaleOriginRect.top+scaleOriginRect.height/2,oppsiteCorner=document.querySelector(".move"),oppsiteCornerRect=oppsiteCorner.getBoundingClientRect(),oppsiteCornerX=oppsiteCornerRect.left+oppsiteCornerRect.width/2,oppsiteCornerY=oppsiteCornerRect.top+oppsiteCornerRect.height/2}),document.addEventListener("mousemove",function(e){if(scaling){var t,l,a,n,r,o,s,c,i,d,m,g;editCanvasRect=editCanvas.getBoundingClientRect(),m=Math.atan(selectedElemOffsetHeight/selectedElemOffsetWidth),t=e.clientX-preX,l=t*Math.tan(ANGLE+m),(ANGLE>=0&&ANGLE<=Math.PI/2||ANGLE>=Math.PI&&ANGLE<=3*Math.PI/2)&&(l=e.clientY-preY,t=l*Math.tan(Math.PI/2-m-ANGLE)),a=scaleOriginX+t,n=scaleOriginY+l,r=(a+oppsiteCornerX)/2,o=(n+oppsiteCornerY)/2,g=Math.sqrt(Math.pow(a+2-oppsiteCornerX,2)+Math.pow(n+2-oppsiteCornerY,2)),i=g*Math.cos(m),d=g*Math.sin(m),s=r-i/2-editCanvasRect.left,c=o-d/2-editCanvasRect.top,selectedElem.style.left=editTransformer.style.left=s+"px",selectedElem.style.top=editTransformer.style.top=c+"px",selectedElem.style.width=editTransformer.style.width=i+"px",selectedElem.style.height=editTransformer.style.height=d+"px"}}),document.addEventListener("mouseup",function(e){scaling=!1}),editToolbar.forEach(function(e){e.childNodes.forEach(function(e){e.addEventListener("click",function(t){switch(canvasEditor.clearStyle(sizeSelect,familySelect,transparentRange),e.className){case"edit-text":document.execCommand("selectAll",!1,null),selectedElem.focus();break;case"change-image":var l=document.querySelector(".replace-img");canvasEditor.replaceImg(l,selectedElem,editTransformer);break;case"edit-transparent":canvasEditor.showEditControler(transparentRange,e),canvasEditor.transparentEdit();break;case"edit-copy":;if(clipboard=selectedElem.cloneNode(!0),"path"==selectedElem.tagName){var a=canvasEditor.getSvgTransform(selectedElem,"translate",!0),n=canvasEditor.getSvgTransform(selectedElem,"scale");clipboard.setAttribute("transform","translate("+parseInt(selectedElemRect.left-editCanvasRect.left+selectedElemRect.width+10)+","+a[1]+")"+n),svg.appendChild(clipboard),console.log(selectedElemRect.left-editCanvasRect.left+selectedElemRect.width+10)}else clipboard.style.left=parseInt(selectedElem.offsetLeft)+selectedElemRect.width+10+"px",editSide.appendChild(clipboard);selectedElem=clipboard,selectedElemRect=selectedElem.getBoundingClientRect(),canvasEditor.showEditTransformer(),canvasEditor.showEditPanel();break;case"edit-putup":"path"==selectedElem.tagName?svg.appendChild(selectedElem):editSide.appendChild(selectedElem);break;case"edit-putdown":"path"==selectedElem.tagName?(console.log(e.tagName),svg.insertBefore(selectedElem,svg.firstChild)):editSide.insertBefore(selectedElem,editSide.firstChild);break;case"edit-delete":selectedElem.parentNode.removeChild(selectedElem),editToolbar.forEach(function(e){e.style.display="none"}),editTransformer.style.display="none";break;case"edit-color":var r=document.querySelector(".edit-color"),o=e.querySelector("input[type = color]");o.onchange=function(){"path"==selectedElem.tagName?selectedElem.setAttribute("fill",o.value):(selectedElem.style.color=o.value,r.style.backgroundColor=o.value)};break;case"edit-fontfamily":"flex"==familySelect.style.display?familySelect.style.display="none":canvasEditor.showEditControler(familySelect,e);break;case"edit-fontsize":var s,c=document.querySelector(".edit-fontsize"),i=c.querySelector("span");console.log(sizeSelect.style.display),"flex"==sizeSelect.style.display?sizeSelect.style.display="none":canvasEditor.showEditControler(sizeSelect,e),sizeSelect.addEventListener("mousemove",function(e){s=parseInt(e.target.innerText),selectedElem.style.fontSize=s+"px",canvasEditor.showEditTransformer(editTransformer,selectedElem)}),sizeSelect.addEventListener("click",function(e){i.innerText=s,canvasEditor.clearStyle(sizeSelect)});break;case"edit-fontitaly":"italic"==selectedElem.style.fontStyle?(e.style.backgroundColor="",selectedElem.style.fontStyle=""):(e.style.backgroundColor="#e0e0e0",selectedElem.style.fontStyle="italic");break;case"edit-fontunderline":"underline"==selectedElem.style.textDecoration?(e.style.backgroundColor="",selectedElem.style.textDecoration=""):(e.style.backgroundColor="#e0e0e0",selectedElem.style.textDecoration="underline");break;case"edit-fontbold":"bold"==selectedElem.style.fontWeight?(e.style.backgroundColor="",selectedElem.style.fontWeight=""):(e.style.backgroundColor="#e0e0e0",selectedElem.style.fontWeight="bold")}})})}),document.addEventListener("keydown",function(e){46===e.keyCode&&selectedElem&&(selectedElem.parentNode.removeChild(selectedElem),editToolbar.forEach(function(e){e.style.display="none"}),editTransformer.style.display="none")}),canvasEditor.addText();var cancel=document.querySelector(".cancel");cancel.addEventListener("click",function(e){canvasEditor.clearStyle(textToolbar,imageToolbar,editTransformer)});var addImg=document.querySelector(".add-img-input");canvasEditor.addImg(addImg);var panelTabs=document.querySelector(".panel-tabs"),tabButtons=panelTabs.querySelectorAll("button");tabButtons.forEach(function(e){e.addEventListener("click",function(t){var l=document.querySelector(".side-front"),a=document.querySelector(".side-back");canvasEditor.clearStyle(textToolbar,imageToolbar,editTransformer),e.classList.contains("panel-tabs-active")||(tabButtons.forEach(function(e){e.classList.remove("panel-tabs-active")}),e.classList.add("panel-tabs-active")),e.classList.contains("panel-tabs-active")&&e.classList.contains("the-front")?(l.style.display="block",editSide=l,a.style.display="none",svg=editSide.querySelector("svg")):(l.style.display="none",a.style.display="block",editSide=a,svg=editSide.querySelector("svg"))})}),function(){var e=document.querySelector(".type");if(e){var t=e.querySelectorAll("div"),l=e.querySelectorAll("ul"),a=e.querySelectorAll("i");t.forEach(function(e){e.onclick=function(t){var n=e.querySelector("span"),r=e.querySelector("ul"),o=e.querySelector("i");a.forEach(function(e){e.style.transform="rotate(0deg)"}),"none"==window.getComputedStyle(r).display?(l.forEach(function(e){e.style.display="none"}),r.style.display="block",o.style.transform="rotate(180deg)"):(r.style.display="none",o.style.transform="rotate(0deg)"),"LI"==t.target.tagName&&(n.innerText=t.target.innerText)}})}}(),function(){function e(e){var t,l;html2canvas(e).then(function(a){l=a.toDataURL(),"side-front"==e.className?t="正面.png":"side-back"==e.className&&(t="反面.png"),n.file(t,l.replace(/^data:image\/\w+;base64,/,""),{base64:!0})})}var t=document.querySelector(".side-front"),l=document.querySelector(".side-back"),a=[],n=new JSZip;t&&a.push(t),l&&a.push(l);var r=document.querySelector(".save");r&&(r.onclick=function(){a.forEach(function(t){"none"==window.getComputedStyle(t).display?(t.style.display="block",e(t),t.style.display="none"):e(t)}),setTimeout(function(){n.generateAsync({type:"blob"}).then(function(e){saveAs(e,"拿去打印吧.zip")})},500)})}();var sidebarUser=document.querySelector(".sidebar-user");sidebarUser&&sidebarUser.addEventListener("click",function(e){canvasEditor.clearStyle(editTransformer,textToolbar,imageToolbar)});var svgTransformer=document.querySelector(".svg-transformer"),scaling=!1,direction,originX,originY,originRect={};svgTransformer.addEventListener("mousedown",function(e){selectedElemRect=selectedElem.getBoundingClientRect(),scaling=!0,direction=e.target.className,originX=e.clientX,originY=e.clientY;var t=canvasEditor.getSvgTransform(selectedElem,"scale",!0);originRect.width=selectedElemRect.width/t[0],originRect.height=selectedElemRect.height/t[1],originRect.prop=selectedElemRect.width/selectedElemRect.height,originRect.translate=canvasEditor.getSvgTransform(selectedElem,"translate",!0)||""}),function(){function e(e){var t=e.clientX-originX,l=selectedElemRect.width+t,a=canvasEditor.getSvgTransform(selectedElem,"translate")||"",n=canvasEditor.getSvgTransform(selectedElem,"scale",!0),r=l/originRect.width;r>0&&(selectedElem.setAttribute("transform",a+" scale("+r+","+n[1]+")"),canvasEditor.showEditTransformer())}function t(e){var t=e.clientY-originY,l=selectedElemRect.height+t,a=canvasEditor.getSvgTransform(selectedElem,"translate")||"",n=canvasEditor.getSvgTransform(selectedElem,"scale",!0),r=l/originRect.height;r>0&&(selectedElem.setAttribute("transform",a+"scale("+n[0]+","+r+")"),canvasEditor.showEditTransformer())}function l(e){var t=e.clientY-originY,l=selectedElemRect.height-t,a=l/originRect.height,n=canvasEditor.getSvgTransform(selectedElem,"translate",!0)||"",r=canvasEditor.getSvgTransform(selectedElem,"scale",!0);a>0&&(selectedElem.setAttribute("transform","translate("+n[0]+","+(parseInt(originRect.translate[1])+t)+")scale("+r[0]+","+a+")"),canvasEditor.showEditTransformer())}function a(e){var t=e.clientX-originX,l=selectedElemRect.width-t,a=l/originRect.width,n=canvasEditor.getSvgTransform(selectedElem,"translate",!0)||"",r=canvasEditor.getSvgTransform(selectedElem,"scale",!0);a>0&&(selectedElem.setAttribute("transform","translate("+(parseInt(originRect.translate[0])+t)+","+n[1]+")scale("+a+","+r[1]+")"),canvasEditor.showEditTransformer())}document.addEventListener("mousemove",function(n){if(scaling)switch(direction){case"e":e(n);break;case"s":t(n);break;case"se":e(n);var r=selectedElem.getBoundingClientRect(),o=r.width/originRect.prop,s=o/originRect.height,c=canvasEditor.getSvgTransform(selectedElem,"translate")||"",i=canvasEditor.getSvgTransform(selectedElem,"scale",!0);selectedElem.setAttribute("transform",c+"scale("+i[0]+","+s+")"),canvasEditor.showEditTransformer();break;case"n":l(n);break;case"w":a(n);break;case"nw":l(n),a(n);break;case"ne":l(n),e(n);break;case"sw":t(n),a(n)}}),document.addEventListener("mouseup",function(e){scaling=!1})}();var buttonAddSvg=document.querySelector(".button-add-svg"),svgInput=document.querySelector(".svg-input"),addSvg=document.querySelector(".add-svg"),buttonCancelSvg=document.querySelector(".button-cancle-svg");addSvg&&addSvg.addEventListener("click",function(e){svgInput.style.display="block"}),buttonCancelSvg&&buttonCancelSvg.addEventListener("click",function(e){svgInput.style.display="none"}),buttonAddSvg&&buttonAddSvg.addEventListener("click",function(e){var t,l=document.querySelector(".svg-content"),a=editSide.querySelector("defs"),n=Date.now(),r=/<defs>[\s\S]*<\/defs>/gm;r.test(l.value)&&(t=l.value.match(r)[0].replace(/<\/defs>/,"").replace(/<defs>/,"").replace("PSgrad_0",n),a.innerHTML+=t);var o,s=/<path[\s\S]*>/gm;s.test(l.value)&&(o=l.value.match(s)[0].replace(/<\/path>/,"").replace(/<path>/,"").replace("PSgrad_0",n),svg.innerHTML+=o,console.log(svg),console.log(o)),document.querySelectorAll("path").forEach(function(e){e.classList.add("edit-elem"),e.classList.add("edit-svg")})});